name: CI/CD Pipeline

on: push

permissions:
  contents: write
  issues: write
  pull-requests: write
  packages: write

env:
  PYTHON_VERSION: '3.13'
  SEMANTIC_VERSION: '19.0.2'
  working-dir: .

jobs:
  lint:
    name: Code Quality Checks
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: pip
          cache-dependency-path: |
            requirements.txt
            requirements-dev.txt

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt -r requirements-dev.txt

      - name: Check code formatting (Black)
        run: black --check .

      - name: Check import ordering (isort)
        run: isort --check-only .

      - name: Lint code (Ruff)
        run: ruff check .

      - name: Type check (MyPy)
        run: mypy agentsmithy_server

  test:
    name: Run Tests
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: pip
          cache-dependency-path: |
            requirements.txt
            requirements-dev.txt

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt -r requirements-dev.txt

      - name: Run tests
        run: pytest -v || test $? -eq 5

  semver:
    name: Release Version Management
    outputs:
      new_sha: ${{ steps.sha.outputs.SHA }}
      new_release_published: ${{ steps.semantic.outputs.new_release_published }}
      new_release_version: ${{ steps.semantic.outputs.new_release_version }}
    runs-on: ubuntu-latest
    # Run semantic-release only on main/master branches
    if: startsWith(github.ref, 'refs/heads/master') || startsWith(github.ref, 'refs/heads/main')
    needs: [lint, test]
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Semantic Release
        id: semantic
        uses: cycjimmy/semantic-release-action@v4
        with:
          semantic_version: ${{ env.SEMANTIC_VERSION }}
          extra_plugins: |
            @semantic-release/changelog@6.0.0
            @semantic-release/git@10.0.0
            @semantic-release/exec@6.0.1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Get SHA
        id: sha
        run: |
          sha_new=$(git rev-parse HEAD)
          echo $sha_new
          echo "SHA=$sha_new" >> $GITHUB_OUTPUT

      - run: echo ${{ steps.sha.outputs.SHA }}
      - run: echo "New release published=${{ steps.semantic.outputs.new_release_published }}"
      - run: echo "New release version=${{ steps.semantic.outputs.new_release_version }}"


  build_binaries:
    name: Build Executables
    runs-on: ${{ matrix.runner }}
    needs: [semver]
    # Build binaries only when a new release was published or on tags
    if: |
      (needs.semver.outputs.new_release_published == 'true') || 
      startsWith(github.ref, 'refs/tags/')
    strategy:
      fail-fast: false
      matrix:
        include:
          - runner: ubuntu-latest
            label: linux-amd64
          # NOTE: Linux ARM64 on GitHub-hosted runners is not available on the free plan.
          # TODO: Enable when upgrading plan or using a self-hosted ARM64 runner.
          # - runner: ubuntu-24.04-arm64
          #   label: linux-arm64
          # Example for self-hosted ARM64 runner (labels must match your runner):
          # - runner: [self-hosted, Linux, ARM64]
          #   label: linux-arm64
          - runner: windows-latest
            label: windows-amd64
          - runner: macos-14
            label: macos-arm64
          - runner: macos-13
            label: macos-amd64
    steps:
      - name: Checkout code at release SHA
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          ref: ${{ needs.semver.outputs.new_sha }}

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: pip
          cache-dependency-path: |
            requirements.txt
            requirements-dev.txt

      - name: Derive release tag and version
        id: ver
        shell: bash
        run: |
          git fetch --tags --force
          TAG=$(git tag --points-at ${{ needs.semver.outputs.new_sha }} | head -n1)
          VER=""
          if [ -n "$TAG" ]; then
            VER=${TAG#v}
          else
            # Use version from semantic-release if available
            VER="${{ needs.semver.outputs.new_release_version }}"
          fi
          echo "tag=$TAG" >> $GITHUB_OUTPUT
          echo "version=$VER" >> $GITHUB_OUTPUT

      - name: Install build dependencies
        shell: bash
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt -r requirements-dev.txt

      - name: Build executable with PyInstaller
        shell: bash
        run: |
          pyinstaller --version
          pyinstaller --onefile \
            --name agentsmithy \
            main.py

      - name: Rename artifacts with version and latest aliases
        shell: bash
        run: |
          set -euo pipefail
          EXT=""
          if [ "${{ runner.os }}" = "Windows" ]; then EXT=".exe"; fi
          SRC="dist/agentsmithy${EXT}"
          LATEST_NAME="dist/agentsmithy-${{ matrix.label }}-latest${EXT}"
          if [ -n "${{ steps.ver.outputs.version }}" ]; then
            VER_NAME="dist/agentsmithy-${{ matrix.label }}-${{ steps.ver.outputs.version }}${EXT}"
            mv "$SRC" "$VER_NAME"
            cp "$VER_NAME" "$LATEST_NAME"
          else
            mv "$SRC" "$LATEST_NAME"
          fi

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: agentsmithy-${{ matrix.label }}
          path: |
            dist/agentsmithy-*

  release_upload:
    name: Publish Release Assets
    runs-on: ubuntu-latest
    needs: [build_binaries, semver]
    # Run only when build_binaries succeeded (which means there was a new release or tag)
    if: needs.build_binaries.result == 'success'
    steps:
      - name: Checkout code at release SHA
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          ref: ${{ needs.semver.outputs.new_sha }}

      - name: Download artifacts
        uses: actions/download-artifact@v4
        with:
          pattern: agentsmithy-*
          merge-multiple: true

      - name: Find release tag for SHA
        id: tag
        run: |
          git fetch --tags --force
          TAG=$(git tag --points-at ${{ needs.semver.outputs.new_sha }} | head -n1)
          if [ -z "$TAG" ]; then
            echo "No tag found for release sha; skipping upload" && exit 0
          fi
          echo "tag=$TAG" >> $GITHUB_OUTPUT

      - name: Create/update release with assets
        if: steps.tag.outputs.tag != ''
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ steps.tag.outputs.tag }}
          files: |
            agentsmithy*
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Publish to GitHub Packages
        if: steps.tag.outputs.tag != ''
        shell: bash
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          set -euo pipefail
          VER=${{ steps.tag.outputs.tag }}
          VER=${VER#v}
          for f in agentsmithy-*; do
            echo "Uploading $f to GitHub Packages version $VER"
            curl -sS -X PUT \
              -H "Authorization: Bearer $GH_TOKEN" \
              -H "Content-Type: application/octet-stream" \
              -H "X-GitHub-Api-Version: 2022-11-28" \
              --data-binary @"$f" \
              "https://uploads.github.com/repos/${{ github.repository }}/packages/generic/agentsmithy/${VER}/$f"
          done



